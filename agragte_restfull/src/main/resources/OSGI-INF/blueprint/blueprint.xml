<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
           xsi:schemaLocation="
             http://www.osgi.org/xmlns/blueprint/v1.0.0 https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
             http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/cxf/camel-cxf.xsd
             http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd
             http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd
             ">

    <!--<broker xmlns="http://activemq.apache.org/schema/core" persistent="true">-->
        <!--<transportConnectors>-->
            <!--<transportConnector name="tcp" uri="tcp://localhost:61616"/>-->
        <!--</transportConnectors>-->
        <!--<persistenceAdapter>-->
            <!--<kahaDB id="user_kahadb" directory="activemq-data"></kahaDB>-->
        <!--</persistenceAdapter>-->
    <!--</broker>-->

    <bean id="amq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="brokerURL" value="tcp://localhost:61616"/>
        <property name="userName" value="Username" />
        <property name="password" value="Password" />
    </bean>



    <bean id="userServiceNormalizer" class="com.cameltraining.aggragatesample.UserServiceRequestNormalizer"></bean>
    <bean id="userServiceToUserDataConverter" class="com.cameltraining.aggragatesample.UserServiceRequestToUserDataConverter"></bean>
    <bean id="userServiceAggregationStrategy" class="com.cameltraining.aggragatesample.UserServiceAggregationStrategy"></bean>
    <cxf:rsServer id="sampleService" address="http://localhost:8383" serviceClass="com.cameltraining.aggragatesample.ISampleService">
    </cxf:rsServer>
    <camelContext id="camel-context" xmlns="http://camel.apache.org/schema/blueprint">
        <dataFormats>
            <json id="gson" library="Gson"/>
        </dataFormats>
        <route id="inbound-route">
            <from uri="cxfrs:bean:sampleService?bindingStyle=SimpleConsumer"/>
            <process ref="userServiceNormalizer"></process>
            <log message="\nheaders===>${headers}\n"></log>
            <log message="\nbody===>${body}\n"></log>
            <wireTap uri="amq:userServiceQueue:received"></wireTap>
            <!--<multicast>-->
                <!--<to uri="amq:userServiceQueue:received"></to>-->
            <!--</multicast>-->
            <transform>
                <constant>OK</constant>
            </transform>
        </route>
        <route id="aggragate-route">
            <from uri="amq:userServiceQueue:received"></from>
            <aggregate strategyRef="userServiceAggregationStrategy">
                <correlationExpression>
                    <header>correlationId</header>
                </correlationExpression>
                <completionSize>
                    <header>completionSize</header>
                </completionSize>
                <to uri="direct:mylog"/>
            </aggregate>

        </route>
        <route id="dummy-route">
            <from uri="direct:mylog"></from>

            <log message="###AGGREATED MESSAGE### ${body}"></log>
        </route>
    </camelContext>
</blueprint>